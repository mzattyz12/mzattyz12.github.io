<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de notificaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>

  <!-- TODO: tu CSS va aqu칤 (no lo repito para no romper el mensaje) -->
</head>
<body>
  <!-- TU UI EXACTA (la que me pasaste) -->
  <!-- PEGA AQU칈 TODO TU BODY TAL CUAL LO ENVIASTE -->

<script>
/* ================== FIREBASE CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyDdmrhtCWO0Dk_g1ZjVD3W7YvIfbJRi0jI",
  authDomain: "messgsender.firebaseapp.com",
  projectId: "messgsender",
  storageBucket: "messgsender.firebasestorage.app",
  messagingSenderId: "271051103266",
  appId: "1:271051103266:web:c92c4d33e340bdb3a2fe7b",
  measurementId: "G-77SHQB6YFK"
};

firebase.initializeApp(firebaseConfig);
firebase.analytics();

const messaging = firebase.messaging();
const db = firebase.firestore();

const PASSWORD = "981423";
const FUNCTION_URL = "https://us-central1-messgsender.cloudfunctions.net/sendPush";

/* ================== UI HELPERS ================== */
function showToast(type, title, text) {
  alert(title + ": " + text);
}

function showModal(title, text) {
  document.getElementById("modalTitle").innerText = title;
  document.getElementById("modalMessage").innerText = text;
  document.getElementById("modalOverlay").classList.remove("hidden");
}

document.getElementById("modalCloseBtn").onclick = () => {
  document.getElementById("modalOverlay").classList.add("hidden");
};

document.getElementById("modalCancel").onclick = () => {
  document.getElementById("modalOverlay").classList.add("hidden");
};

document.getElementById("modalOk").onclick = () => {
  document.getElementById("modalOverlay").classList.add("hidden");
};

/* ================== GATE ================== */
document.getElementById("gateEnter").onclick = () => {
  const pass = document.getElementById("gatePassword").value;
  if (pass === PASSWORD) {
    document.getElementById("gate").style.display = "none";
    document.getElementById("appShell").style.display = "block";
  } else {
    showModal("Error", "Contrase침a incorrecta");
  }
};

/* ================== THEME ================== */
document.getElementById("themeToggle").onclick = () => {
  document.body.classList.toggle("dark");
};

/* ================== PERMISSION ================== */
async function requestPermission() {
  try {
    const token = await messaging.getToken({
      vapidKey: "PEGA_AQUI_TU_VAPID_KEY"
    });

    const indicativo = document.getElementById("indicativoInput").value || "dispositivo-" + Date.now();

    await db.collection("lvp").doc(token).set({
      token,
      indicativo,
      createdAt: new Date()
    });

    renderLVP();
    document.getElementById("permissionDot").classList.add("ok");
    document.getElementById("permissionText").innerText = "Permiso concedido";
    showModal("OK", "Notificaciones activadas");
  } catch (e) {
    showModal("Error", "No se pudo activar notificaciones");
  }
}

document.getElementById("requestPermission").onclick = requestPermission;

/* ================== LVP ================== */
async function renderLVP() {
  const snap = await db.collection("lvp").get();
  const list = document.getElementById("deviceList");
  list.innerHTML = "";
  document.getElementById("deviceCount").innerText = snap.size + " dispositivos registrados";

  snap.forEach(doc => {
    const d = doc.data();
    const el = document.createElement("div");
    el.className = "list-item";
    el.innerHTML = `
      <span class="list-item-label">${d.indicativo}</span>
      <span class="list-item-meta">OK</span>
    `;
    list.appendChild(el);
  });
}

renderLVP();

/* ================== SEND PUSH ================== */
document.getElementById("sendButton").onclick = async () => {
  const indicativo = document.getElementById("indicativoInput").value;
  const mensaje = document.getElementById("mensajeInput").value;

  if (!indicativo || !mensaje) {
    showModal("Error", "Rellena indicativo y mensaje");
    return;
  }

  const res = await fetch(FUNCTION_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ indicativo, mensaje, password: PASSWORD })
  });

  const data = await res.json();

  if (data.ok) {
    showModal("Enviado", "Notificaci칩n enviada correctamente");
  } else {
    showModal("Error", data.error || "Error enviando notificaci칩n");
  }
};

/* ================== LVP BUTTON ================== */
document.getElementById("lvpButton").onclick = () => {
  const pass = prompt("Contrase침a LVP:");
  if (pass !== PASSWORD) {
    showModal("Error", "Contrase침a incorrecta");
  } else {
    showModal("LVP", "Dispositivos cargados abajo 游녢");
  }
};
</script>
</body>
</html>
