<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de notificaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics-compat.js"></script>
  <style>
    :root {
      --bg: #f5f5f7;
      --bg-elevated: #ffffff;
      --text: #111111;
      --text-secondary: #6e6e73;
      --accent: #007aff;
      --accent-soft: rgba(0,122,255,0.12);
      --border: #d2d2d7;
      --danger: #ff3b30;
      --success: #34c759;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.08);
      --radius-large: 18px;
      --radius-medium: 12px;
      --radius-small: 8px;
      --transition-fast: 0.18s ease-out;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "SF Pro Display", "Segoe UI", sans-serif;
    }
    .dark {
      --bg: #000000;
      --bg-elevated: #1c1c1e;
      --text: #f5f5f7;
      --text-secondary: #8e8e93;
      --accent: #0a84ff;
      --accent-soft: rgba(10,132,255,0.18);
      --border: #3a3a3c;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.7);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top, #dfe9ff 0, var(--bg) 45%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .app-shell {
      width: 100%;
      max-width: 960px;
      min-height: 520px;
      background: linear-gradient(145deg, var(--bg-elevated), var(--bg));
      border-radius: 32px;
      box-shadow: var(--shadow-soft);
      padding: 20px 24px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.4);
    }
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .app-title-group { display: flex; flex-direction: column; gap: 2px; }
    .app-title { font-size: 20px; font-weight: 600; letter-spacing: -0.02em; }
    .app-subtitle { font-size: 13px; color: var(--text-secondary); }
    .header-actions { display: flex; align-items: center; gap: 10px; }
    .chip { font-size: 11px; padding: 4px 10px; border-radius: 999px; background: var(--accent-soft); color: var(--accent); border: 1px solid rgba(0,0,0,0.03); }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(0,0,0,0.04);
      color: var(--text);
      transition: background var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast), color var(--transition-fast);
    }
    .btn:hover, .btn-icon:hover { transform: translateY(-0.5px); }
    .btn-primary { background: var(--accent); color: #ffffff; box-shadow: 0 8px 20px rgba(0,122,255,0.35); }
    .btn-primary:hover { background: #0060df; box-shadow: 0 10px 26px rgba(0,122,255,0.45); }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-icon {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      padding: 0;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      background: rgba(0,0,0,0.04);
    }
    .app-main { display: grid; grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr); gap: 18px; height: calc(100% - 52px); }
    @media (max-width: 800px) { .app-shell { border-radius: 0; min-height: 100vh; } .app-main { grid-template-columns: 1fr; height: auto; } }
    .card {
      background: rgba(255,255,255,0.7);
      border-radius: var(--radius-large);
      padding: 16px 16px 18px;
      border: 1px solid rgba(255,255,255,0.7);
      box-shadow: 0 10px 30px rgba(0,0,0,0.04);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      position: relative;
      overflow: hidden;
    }
    .dark .card { background: rgba(28,28,30,0.9); border-color: rgba(255,255,255,0.06); box-shadow: 0 18px 40px rgba(0,0,0,0.7); }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .card-title { font-size: 15px; font-weight: 600; letter-spacing: -0.01em; }
    .card-subtitle { font-size: 12px; color: var(--text-secondary); }
    .badge { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: rgba(0,0,0,0.04); color: var(--text-secondary); }
    .field-group { display: flex; flex-direction: column; gap: 10px; margin-top: 8px; }
    .field-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 2px; }
    .input {
      width: 100%;
      border-radius: var(--radius-medium);
      border: 1px solid var(--border);
      padding: 9px 11px;
      font-size: 13px;
      background: rgba(255,255,255,0.9);
      color: var(--text);
      outline: none;
      transition: border var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), transform var(--transition-fast);
    }
    .input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px rgba(0,122,255,0.3); transform: translateY(-0.5px); background: #ffffff; }
    .dark .input { background: rgba(44,44,46,0.95); border-color: #3a3a3c; }
    .textarea { min-height: 90px; resize: vertical; }
    .card-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 12px; gap: 10px; flex-wrap: wrap; }
    .hint { font-size: 11px; color: var(--text-secondary); }
    .status-dot { width: 8px; height: 8px; border-radius: 999px; margin-right: 4px; display: inline-block; background: var(--danger); }
    .status-dot.ok { background: var(--success); }
    .pill { display: inline-flex; align-items: center; padding: 4px 9px; border-radius: 999px; font-size: 11px; background: rgba(0,0,0,0.04); color: var(--text-secondary); gap: 4px; }
    .list { margin-top: 8px; max-height: 220px; overflow: auto; padding-right: 4px; -webkit-overflow-scrolling: touch; }
    .list-item { display: flex; align-items: center; justify-content: space-between; padding: 7px 9px; border-radius: var(--radius-medium); font-size: 12px; background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.03); margin-bottom: 6px; }
    .dark .list-item { background: rgba(44,44,46,0.9); border-color: rgba(255,255,255,0.04); }
    .list-item-label { font-weight: 500; }
    .list-item-meta { font-size: 11px; color: var(--text-secondary); }
    .tag { font-size: 11px; padding: 2px 7px; border-radius: 999px; background: var(--accent-soft); color: var(--accent); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .overlay.hidden { display: none; }
    .modal { width: 100%; max-width: 360px; background: var(--bg-elevated); border-radius: 22px; padding: 18px 18px 14px; box-shadow: var(--shadow-soft); border: 1px solid rgba(255,255,255,0.6); position: relative; max-height: 80vh; overflow-y: auto; }
    .dark .modal { border-color: rgba(255,255,255,0.08); }
    .modal-title { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
    .modal-text { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }
    .modal-close { position: absolute; top: 10px; right: 10px; border: none; background: transparent; color: var(--text-secondary); cursor: pointer; font-size: 16px; }
    .badge-permission { font-size: 11px; padding: 3px 8px; border-radius: 999px; background: rgba(0,0,0,0.04); color: var(--text-secondary); display: inline-flex; align-items: center; gap: 4px; }
    .badge-dot { width: 7px; height: 7px; border-radius: 999px; background: var(--danger); }
    .badge-dot.ok { background: var(--success); }
    .gate-overlay { position: fixed; inset: 0; background: radial-gradient(circle at top, #dfe9ff 0, #000000 55%); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    .gate-card { width: 100%; max-width: 360px; background: rgba(255,255,255,0.9); border-radius: 26px; padding: 22px 20px 18px; box-shadow: 0 26px 60px rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.8); text-align: center; backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
    .gate-title { font-size: 18px; font-weight: 600; margin-bottom: 4px; letter-spacing: -0.02em; }
    .gate-subtitle { font-size: 13px; color: #6e6e73; margin-bottom: 14px; }
    .gate-footer { font-size: 11px; color: #8e8e93; margin-top: 8px; }
    .dark .gate-card { background: rgba(28,28,30,0.96); border-color: rgba(255,255,255,0.08); color: #f5f5f7; }
    .dark .gate-subtitle, .dark .gate-footer { color: #8e8e93; }
  </style>
</head>
<body>
<div id="gate" class="gate-overlay">
  <div class="gate-card">
    <div class="gate-title">Acceso al panel</div>
    <div class="gate-subtitle">Introduce la contrase√±a para entrar al panel de mensajes.</div>
    <div class="field-group gate-input">
      <div class="field-label">Contrase√±a</div>
      <input id="gatePassword" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    <button id="gateEnter" class="btn btn-primary" style="width: 100%; margin-top: 4px;">Entrar</button>
    <div class="gate-footer">Seguridad b√°sica. No usar para datos sensibles reales.</div>
  </div>
</div>

<div class="app-shell" id="appShell" style="display:none;">
  <header class="app-header">
    <div class="app-title-group">
      <div class="app-title">Panel de notificaciones</div>
      <div class="app-subtitle">Env√≠a mensajes a dispositivos que han aceptado notificaciones (demo local).</div>
    </div>
    <div class="header-actions">
      <span id="permissionBadge" class="badge-permission">
        <span class="badge-dot" id="permissionDot"></span>
        <span id="permissionText">Permiso no solicitado</span>
      </span>
      <button id="themeToggle" class="btn btn-icon" title="Cambiar tema">üåó</button>
      <button id="lvpButton" class="btn btn-ghost">LVP</button>
    </div>
  </header>

  <main class="app-main">
    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Mensaje a dispositivo</div>
          <div class="card-subtitle">Define un indicativo (nombre o IPv4) y el contenido del mensaje.</div>
        </div>
        <span class="badge">Notificaci√≥n local</span>
      </div>
      <div class="field-group">
        <div>
          <div class="field-label">Indicativo del dispositivo (nombre o IPv4)</div>
          <input id="indicativoInput" class="input" placeholder="Ej. dispositivo-01 o 192.168.1.23"/>
        </div>
        <div>
          <div class="field-label">Mensaje</div>
          <textarea id="mensajeInput" class="input textarea" placeholder="Escribe aqu√≠ el contenido de la notificaci√≥n..."></textarea>
        </div>
      </div>
      <div class="card-footer">
        <div class="hint">
          <span class="status-dot" id="notifyStatusDot"></span>
          <span id="notifyStatusText">Permiso de notificaciones no concedido.</span>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="requestPermission" class="btn">Activar notificaciones</button>
          <button id="sendButton" class="btn btn-primary">Enviar notificaci√≥n</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Resumen de dispositivos</div>
          <div class="card-subtitle">Lista local de indicativos (nombres o IPv4) que han aceptado notificaciones.</div>
        </div>
        <span class="badge">LVP</span>
      </div>
      <div class="field-group">
        <div class="pill">
          <span class="status-dot ok"></span>
          <span id="deviceCount">0 dispositivos registrados</span>
        </div>
        <div class="hint">Se guarda en <code>localStorage</code> del navegador actual. No es un sistema de tracking real ni global.</div>
      </div>
      <div class="list" id="deviceList"></div>
    </section>
  </main>
</div>

<div id="modalOverlay" class="overlay hidden">
  <div class="modal">
    <button class="modal-close" id="modalCloseBtn">&times;</button>
    <div class="modal-title" id="modalTitle">T√≠tulo</div>
    <div class="modal-text" id="modalMessage">Mensaje</div>
    <div class="modal-actions" id="modalActions">
      <button class="btn btn-ghost" id="modalCancel">Cancelar</button>
      <button class="btn btn-primary" id="modalOk">Aceptar</button
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDdmrhtCWO0Dk_g1ZjVD3W7YvIfbJRi0jI",
  authDomain: "messgsender.firebaseapp.com",
  projectId: "messgsender",
  storageBucket: "messgsender.firebasestorage.app",
  messagingSenderId: "271051103266",
  appId: "1:271051103266:web:c92c4d33e340bdb3a2fe7b",
  measurementId: "G-77SHQB6YFK"
};

firebase.initializeApp(firebaseConfig);
firebase.analytics();

const messaging = firebase.messaging();
const db = firebase.firestore();
const PASSWORD = "981423";
const FUNCTION_URL = "https://us-central1-messgsender.cloudfunctions.net/sendPush";
const VAPID_KEY = "BBHuiio-g9qiWRkKoWakdlnFG3_fUAlFKydWwnGp50eKvqaEzSWTAoHAfYExuJt0LnPbuuscck8V_Q3Em1A1I6g";

function showModal(title, text) {
  document.getElementById("modalTitle").innerText = title;
  document.getElementById("modalMessage").innerText = text;
  document.getElementById("modalOverlay").classList.remove("hidden");
}

document.getElementById("modalCloseBtn").onclick = () => document.getElementById("modalOverlay").classList.add("hidden");
document.getElementById("modalCancel").onclick = () => document.getElementById("modalOverlay").classList.add("hidden");
document.getElementById("modalOk").onclick = () => document.getElementById("modalOverlay").classList.add("hidden");

document.getElementById("gateEnter").onclick = () => {
  const pass = document.getElementById("gatePassword").value.trim();
  if(pass === PASSWORD){
    document.getElementById("gate").style.display = "none";
    document.getElementById("appShell").style.display = "block";
  } else {
    showModal("Error","Contrase√±a incorrecta");
  }
};

document.getElementById("gatePassword").addEventListener("keydown", e => {
  if(e.key === "Enter") document.getElementById("gateEnter").click();
});

document.getElementById("themeToggle").onclick = () => document.body.classList.toggle("dark");

async function requestPermission() {
  try {
    const permission = await Notification.requestPermission();
    if(permission !== "granted") throw new Error("Permiso denegado");

    const token = await messaging.getToken({ vapidKey: VAPID_KEY });
    const indicativo = document.getElementById("indicativoInput").value || "dispositivo-" + Date.now();
    await db.collection("lvp").doc(token).set({ token, indicativo, createdAt: new Date() });
    renderLVP();
    document.getElementById("permissionDot").classList.add("ok");
    document.getElementById("permissionText").innerText = "Permiso concedido";
    showModal("OK","Notificaciones activadas");
  } catch(e){
    showModal("Error","No se pudo activar notificaciones");
  }
}

document.getElementById("requestPermission").onclick = requestPermission;

async function renderLVP() {
  const snap = await db.collection("lvp").get();
  const list = document.getElementById("deviceList");
  list.innerHTML = "";
  document.getElementById("deviceCount").innerText = snap.size + " dispositivos registrados";
  snap.forEach(doc => {
    const d = doc.data();
    const el = document.createElement("div");
    el.className = "list-item";
    el.innerHTML = `<span class="list-item-label">${d.indicativo}</span><span class="list-item-meta">OK</span>`;
    list.appendChild(el);
  });
}

renderLVP();

document.getElementById("sendButton").onclick = async () => {
  const indicativo = document.getElementById("indicativoInput").value.trim();
  const mensaje = document.getElementById("mensajeInput").value.trim();
  if(!indicativo || !mensaje){
    showModal("Error","Rellena indicativo y mensaje");
    return;
  }
  try {
    const res = await fetch(FUNCTION_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ indicativo, mensaje, password: PASSWORD })
    });
    const data = await res.json();
    if(data.ok){
      showModal("Enviado","Notificaci√≥n enviada correctamente");
      document.getElementById("mensajeInput").value = "";
      document.getElementById("indicativoInput").value = "";
    } else showModal("Error",data.error || "Error enviando notificaci√≥n");
  } catch(e){
    showModal("Error","Error enviando notificaci√≥n");
  }
};

document.getElementById("lvpButton").onclick = () => {
  const pass = prompt("Contrase√±a LVP:");
  if(pass !== PASSWORD) showModal("Error","Contrase√±a incorrecta");
  else showModal("LVP","Dispositivos cargados abajo üëá");
};
</script>
</body>
</html>
