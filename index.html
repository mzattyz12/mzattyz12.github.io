<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel Push Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <iframe id="uiFrame" src="ui.html" style="border:none;width:100vw;height:100vh;"></iframe>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDdmrhtCWO0Dk_g1ZjVD3W7YvIfbJRi0jI",
    authDomain: "messgsender.firebaseapp.com",
    projectId: "messgsender",
    storageBucket: "messgsender.firebasestorage.app",
    messagingSenderId: "271051103266",
    appId: "1:271051103266:web:c92c4d33e340bdb3a2fe7b",
    measurementId: "G-77SHQB6YFK"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const messaging = firebase.messaging();
  const db = firebase.firestore();

  navigator.serviceWorker.register("firebase-messaging-sw.js");

  window.addEventListener("load", () => {
    const ui = document.getElementById("uiFrame").contentWindow;

    ui.requestPermissionAndRegister = async (indicativo) => {
      const permission = await Notification.requestPermission();
      if (permission !== "granted") return ui.showToast("error", "Permiso denegado", "No se activaron notificaciones");

      const token = await messaging.getToken();
      await db.collection("lvp").doc(token).set({ indicativo, token, createdAt: new Date() });

      ui.showToast("success", "Registrado", "Dispositivo aÃ±adido a LVP");
      ui.refreshLVP();
    };

    ui.sendPushToIndicativo = async (indicativo, mensaje) => {
      const res = await fetch("https://us-central1-messgsender.cloudfunctions.net/sendPush", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ indicativo, mensaje, password: "981423" })
      });

      const data = await res.json();
      if (!res.ok) return ui.showToast("error", "Error", data.error || "No se pudo enviar");

      ui.showToast("success", "Enviado", "NotificaciÃ³n enviada");
    };

    ui.refreshLVP = async () => {
      const snap = await db.collection("lvp").orderBy("createdAt", "desc").get();
      ui.renderLVP(snap.docs.map(d => d.data()));
    };
  });
</script>
</body>
</html>
