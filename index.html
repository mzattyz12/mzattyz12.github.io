<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDdmrhtCWO0Dk_g1ZjVD3W7YvIfbJRi0jI",
    authDomain: "messgsender.firebaseapp.com",
    projectId: "messgsender",
    storageBucket: "messgsender.firebasestorage.app",
    messagingSenderId: "271051103266",
    appId: "1:271051103266:web:c92c4d33e340bdb3a2fe7b",
    measurementId: "G-77SHQB6YFK"
  };

  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  const messaging = firebase.messaging();
  const db = firebase.firestore();

  navigator.serviceWorker.register("firebase-messaging-sw.js");

  window.addEventListener("load", () => {
    const ui = document.getElementById("uiFrame").contentWindow;

    // Request notification permission, get token & public IP, store in Firestore
    ui.requestPermissionAndRegister = async (indicativo) => {
      try {
        const permission = await Notification.requestPermission();
        if (permission !== "granted") {
          return ui.showToast("error", "Permiso denegado", "No se activaron notificaciones");
        }

        // Get FCM token
        const token = await messaging.getToken();

        // Get public IP
        const ipRes = await fetch("https://api.ipify.org?format=json");
        const ipData = await ipRes.json();
        const publicIP = ipData.ip;

        // Save to Firestore
        await db.collection("lvp").doc(token).set({
          indicativo,
          token,
          publicIP,
          createdAt: new Date()
        });

        ui.showToast("success", "Registrado", "Dispositivo añadido a LVP con IP pública");
        ui.refreshLVP();
      } catch (err) {
        console.error(err);
        ui.showToast("error", "Error", "No se pudo registrar el dispositivo");
      }
    };

    // Send push notification through cloud function
    ui.sendPushToIndicativo = async (indicativo, mensaje) => {
      try {
        const res = await fetch("https://us-central1-messgsender.cloudfunctions.net/sendPush", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ indicativo, mensaje, password: "981423" })
        });

        const data = await res.json();
        if (!res.ok) return ui.showToast("error", "Error", data.error || "No se pudo enviar");

        ui.showToast("success", "Enviado", "Notificación enviada");
      } catch (err) {
        console.error(err);
        ui.showToast("error", "Error", "No se pudo enviar la notificación");
      }
    };

    // Refresh LVP list from Firestore
    ui.refreshLVP = async () => {
      try {
        const snap = await db.collection("lvp").orderBy("createdAt", "desc").get();
        ui.renderLVP(snap.docs.map(d => d.data()));
      } catch (err) {
        console.error(err);
        ui.showToast("error", "Error", "No se pudo cargar la lista LVP");
      }
    };
  });
</script>
