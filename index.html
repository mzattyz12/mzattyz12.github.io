<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de notificaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- TODO: AQUÍ VA TU CSS (el que ya enviaste) -->
</head>
<body>

  <!-- TODO: AQUÍ VA TODO TU HTML (el que ya enviaste) -->

  <div class="toast-container" id="toastContainer"></div>

<script>
const PASSWORD = "981423";
const STORAGE_KEY = "lvp_devices";
const THEME_KEY = "theme";

const gate = document.getElementById("gate");
const appShell = document.getElementById("appShell");
const gatePassword = document.getElementById("gatePassword");
const gateEnter = document.getElementById("gateEnter");

const indicativoInput = document.getElementById("indicativoInput");
const mensajeInput = document.getElementById("mensajeInput");
const sendButton = document.getElementById("sendButton");
const requestPermissionBtn = document.getElementById("requestPermission");

const permissionText = document.getElementById("permissionText");
const permissionDot = document.getElementById("permissionDot");
const notifyStatusText = document.getElementById("notifyStatusText");
const notifyStatusDot = document.getElementById("notifyStatusDot");

const deviceList = document.getElementById("deviceList");
const deviceCount = document.getElementById("deviceCount");

const lvpButton = document.getElementById("lvpButton");
const themeToggle = document.getElementById("themeToggle");

const modalOverlay = document.getElementById("modalOverlay");
const modalTitle = document.getElementById("modalTitle");
const modalMessage = document.getElementById("modalMessage");
const modalOk = document.getElementById("modalOk");
const modalCancel = document.getElementById("modalCancel");
const modalCloseBtn = document.getElementById("modalCloseBtn");
const modalExtra = document.getElementById("modalExtra");

const toastContainer = document.getElementById("toastContainer");

function showToast(type, title, text) {
  const toast = document.createElement("div");
  toast.className = `toast toast-${type}`;
  toast.innerHTML = `
    <div class="toast-icon">●</div>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-text">${text}</div>
    </div>
  `;
  toastContainer.appendChild(toast);
  setTimeout(() => toast.remove(), 3500);
}

function showModal(title, message, onOk = null, extraHTML = "") {
  modalTitle.textContent = title;
  modalMessage.textContent = message;
  modalExtra.innerHTML = extraHTML;
  modalOverlay.classList.remove("hidden");

  modalOk.onclick = () => {
    modalOverlay.classList.add("hidden");
    if (onOk) onOk();
  };

  modalCancel.onclick = modalCloseBtn.onclick = () => {
    modalOverlay.classList.add("hidden");
  };
}

function getDevices() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
}

function saveDevice(name) {
  const devices = getDevices();
  if (!devices.includes(name)) {
    devices.push(name);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(devices));
  }
  renderDevices();
}

function renderDevices() {
  const devices = getDevices();
  deviceList.innerHTML = "";
  devices.forEach(d => {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <span class="list-item-label">${d}</span>
      <span class="tag">activo</span>
    `;
    deviceList.appendChild(div);
  });
  deviceCount.textContent = `${devices.length} dispositivos registrados`;
}

function updatePermissionUI() {
  if (Notification.permission === "granted") {
    permissionText.textContent = "Permiso concedido";
    permissionDot.classList.add("ok");
    notifyStatusText.textContent = "Notificaciones activas.";
    notifyStatusDot.classList.add("ok");
  } else {
    permissionText.textContent = "Permiso no concedido";
    permissionDot.classList.remove("ok");
    notifyStatusText.textContent = "Permiso de notificaciones no concedido.";
    notifyStatusDot.classList.remove("ok");
  }
}

requestPermissionBtn.onclick = async () => {
  const res = await Notification.requestPermission();
  updatePermissionUI();
  if (res === "granted") {
    const indicativo = indicativoInput.value.trim() || "dispositivo-" + Date.now();
    saveDevice(indicativo);
    showToast("success", "Permiso concedido", "Dispositivo añadido a LVP");
  } else {
    showToast("error", "Permiso denegado", "No se activaron notificaciones");
  }
};

sendButton.onclick = () => {
  if (Notification.permission !== "granted") {
    showToast("error", "Error", "Primero activa notificaciones");
    return;
  }
  const msg = mensajeInput.value.trim();
  if (!msg) {
    showToast("error", "Mensaje vacío", "Escribe un mensaje");
    return;
  }
  new Notification("Notificación importante", { body: msg });
  showToast("success", "Enviado", "Notificación enviada");
};

gateEnter.onclick = () => {
  if (gatePassword.value === PASSWORD) {
    gate.style.display = "none";
    appShell.style.display = "block";
    showToast("success", "Acceso concedido", "Bienvenido al panel");
  } else {
    showToast("error", "Contraseña incorrecta", "Acceso denegado");
  }
};

lvpButton.onclick = () => {
  showModal("Acceso LVP", "Introduce la contraseña:", () => {
    const pass = document.getElementById("lvpPass").value;
    if (pass === PASSWORD) {
      showModal("Lista LVP", "Dispositivos registrados:");
    } else {
      showToast("error", "Error", "Contraseña incorrecta");
    }
  }, `
    <input id="lvpPass" class="input" type="password" placeholder="Contraseña" />
  `);
};

themeToggle.onclick = () => {
  document.body.classList.toggle("dark");
  localStorage.setItem(THEME_KEY, document.body.classList.contains("dark") ? "dark" : "light");
};

(function init() {
  if (localStorage.getItem(THEME_KEY) === "dark") {
    document.body.classList.add("dark");
  }
  renderDevices();
  updatePermissionUI();
})();
</script>

</body>
</html>
